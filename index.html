<!-- index.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anonymous CyberChat</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js';
        import { getDatabase, ref, push, onValue } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyB-eRbjF4omwbuuM__W4evKAFsK_jlHxWo",
            authDomain: "ewniny.firebaseapp.com",
            databaseURL: "https://ewniny-default-rtdb.firebaseio.com",
            projectId: "ewniny",
            storageBucket: "ewniny.appspot.com",
            messagingSenderId: "376739063376",
            appId: "1:376739063376:web:5e47e361c2418a9c60d355"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const messagesRef = ref(db, 'messages');

        class CyberChat {
            constructor() {
                this.userId = this.generateUserId();
                this.initMatrix();
                this.initChat();
                this.messages = []; // Инициализируем пустой массив сообщений
            }

            generateUserId() {
                const storedId = localStorage.getItem('anonymousId');
                if(storedId) return storedId;
                
                const newId = 'id-' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('anonymousId', newId);
                return newId;
            }

            initMatrix() {
                const canvas = document.getElementById('matrixCanvas');
                if(!canvas) return;
                
                const ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;

                const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#$%^&*()";
                const drops = new Array(Math.floor(canvas.width/20)).fill(0);

                const draw = () => {
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#0F0';
                    ctx.font = '20px monospace';

                    drops.forEach((y, i) => {
                        ctx.fillText(
                            chars[Math.floor(Math.random()*chars.length)],
                            i*20,
                            y*20
                        );
                        drops[i] = y > canvas.height/20 ? 0 : y + 1.5;
                    });

                    requestAnimationFrame(draw);
                };
                draw();
            }

            initChat() {
                this.setupChatForm();
                this.loadChatHistory();
                
                onValue(messagesRef, (snapshot) => {
                    const data = snapshot.val();
                    this.messages = Object.values(data || {});
                    this.renderChat();
                });
            }

            setupChatForm() {
                const form = document.getElementById('chatForm');
                const input = document.querySelector('.chat-input');
                
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const message = input.value.trim();
                    if(message) {
                        this.sendMessage(message);
                        input.value = '';
                    }
                });
            }

            async sendMessage(content) {
                try {
                    await push(messagesRef, {
                        userId: this.userId,
                        content: content,
                        timestamp: Date.now()
                    });
                } catch(error) {
                    console.error("Ошибка отправки:", error);
                    alert('Ошибка отправки: Проверьте подключение и права доступа');
                }
            }

            renderChat() {
                const container = document.querySelector('.chat-container');
                container.innerHTML = '';
                
                this.messages.forEach(msg => {
                    const msgElement = document.createElement('div');
                    msgElement.className = `message ${msg.userId === this.userId ? 'self' : ''}`;
                    
                    msgElement.innerHTML = `
                        <div class="msg-header">
                            <span class="user-id">${msg.userId}</span>
                            <span class="time">${new Date(msg.timestamp).toLocaleTimeString()}</span>
                        </div>
                        <div class="msg-content">${msg.content}</div>
                    `;
                    
                    container.appendChild(msgElement);
                });
                
                container.scrollTop = container.scrollHeight;
            }
        }

        // Инициализация при загрузке
        window.addEventListener('DOMContentLoaded', () => {
            new CyberChat();
        });
    </script>
</head>
<body class="crt">
    <canvas id="matrixCanvas"></canvas>

    <div class="chat-container"></div>

    <form id="chatForm" class="chat-form">
        <input type="text" class="chat-input" placeholder="Введите сообщение...">
        <button type="submit">➤</button>
    </form>

    <div id="webgl-container"></div>
</body>
</html>